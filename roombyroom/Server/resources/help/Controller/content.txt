## The System Controller

The system controller runs continuously, looking after the thermometers and radiators to keep your rooms at their desired temperatures.

The RBR system is fairly complex but we have designed it such that anyone can install and set up their own system. Once set up, the RBR system is quite simple to operate, but as with other complex systems (such as heat pumps or solar panels, for example), most people will probably call in a specialist to set up the system for them. These instructions are for those wishing to do the job themselves (and for those wishing to do it for their own customers). They assume a certain familiarity with the command line and with basic networking principles, but no specialized computing knowledge is required. You will require a computer with an SD card reader/writer. The most complicated part of the process is navigating the admin interface of your Internet router, and because each router model is different this is the one thing for which these instructions can't offer a lot of help.

The system controller can be any computer able to run Python. In practice, the demands made upon it are not great so there are some very low-cost options, the most well-known of which is the Raspberry Pi. This has been in production for several years and the latest models are quite powerful, but the controller software will run on some of the early models. For example a Model B+ can be bought for around £25, with a case costing another £5 or so. Add to this an SD card of at least 8GB, a low-cost USB power supply and a cable.

The following instructions have been tested on a Model B+ and on a Pi 2 Model B. These are both older models; it can safely be assumed that later models will present no problems.

## Pi Model B+ networking

There is an issue with networking on the Model B+ when running the latest "bullseye" version of Raspbian. Basically, wifi fails to start automatically. This may be an issue with certain wifi interfaces, but if you want to use this model the safest thing to do is to connect to your router with an Ethernet cable. (This may be a better solution in any case.) Later Pi models are happy with wifi, and all the more recent ones come with wifi built in. The instructions that follow allow you to choose wifi or Ethernet according to your preferences.

The Pi computer runs from an SD card (8GB or more) that contains the operating system and all the RBR files. The simplest way to set this up is to run the [Raspberry Pi Imager](https://www.raspberrypi.com/news/raspberry-pi-imager-imaging-utility/) on your computer. Here's what it looks like:
~img:imager-1.png:center 70%~
First choose the operating system:
~img:imager-2.png:center 70%~
Choose "Raspberry Pi OS (other)"
~img:imager-3.png:center 70%~
Choose "Raspberry Pi OS Lite (32-bit)"

Then click to select the SD card to write to:
~img:imager-4.png:center 70%~

Now click the gear icon and do the advanced settings. Use these images as a guide:
~img:imager-5.png:center 70%~
~img:imager-6.png:center 70%~
~img:imager-7.png:center 70%~

Click to download the image and write it to the SD card. When it has completed, close the Imager.

In your system File Manager you will see 2 new mounted volumes; `boot` and `rootfs`.

The partition called `rootfs` is where all your files will be. Copy the distribution files - the contents of the `roombyroom/Controller/home/pi` folder in the [RBR repository](https://github.com/easycoder/rbr) - into the `/home/pi` folder on the card.

Note that the Python script `ec_timestamp.py` is set up for British time and will need to be adjusted for other countries.

Now eject the card, put it into the Pi and power it up. The initial boot can take several minutes, so be patient. If you connect a TV monitor to the HDMI port on the Pi you will see repeated restarts until it finally settles down.

## Setting up the system controller

Type the address of your router control panel into your browser. The address varies from one model to another but it's most likely to be one of
```
http://192.168.0.1
http://192.168.1.1
```
If neither of these work, do an online search for the name of your router. This will also tell you how to log in.

A home router manages the devices that connect to it, assigning each one an IP address using a system called DHCP. The RBR system works best if this feature is avoided, since its components need to have fixed known addresses and the addresses supplied by the router are liable to change without warning. In your router admin there will be an option to set the range of addresses to be used by the DHCP server. Make sure this is set to a restricted range - we suggest 200 to 254 as the final part of the IP address. All other addresses will then be free for devices to be allocated as you please.

Note: If you already have equipment such as a network printer and its current address is outside the range you gave above, you may have to set the device up again.

At this point it may be best to restart the router and also the Raspberry Pi. Log into the router again.

One of the sections of your router's admin will show you all the devices connected to it. Some of these will have names; you might recognize your computer and printer, for example. Once the system controller has booted up it will present itself as `rbr` (or whatever you set the hostname to in the Advanced settings of Imager). Make a note of its address.

On your computer, fire up a terminal emulator. On Windows you can use PuTTY; on Mac or Linux use the text console. At the command prompt type
```
ssh pi@192.168.x.y
```
where `192.168.x.y` is the IP address you found in your router admin screen. You'll be prompted for the password you gave in the Advanced settings. After a few seconds you'll see the standard greeting.

Once all this is done, type `ls`. You should see all the distribution files you copied earlier.

Now type
```
./update.sh
```
This will cause the system to update itself and may well take quite a long time (tens of minutes).

Next, type
```
./setup.sh
```
The system will ask you some questions regarding your WiFi settings. Once this is done the Pi will reboot automatically and you will have to log in again, this time using your chosen IP address.

Although the questions are very simple, take care or you may put the system firmware into a state from which you will be unable to recover. The worst case would require you to reprogram the SD card and start again. If you are unsure what to type at any point, [email us](mailto:info@rbrsoftware.com) to ask for help. You can abandon the setup at any point; simply power down the controller.

To test if your system controller is connected to the Internet, type
```
ping rbrcontrol.com
```
This should give a stream of responses from the remote server (type Control-C to stop it). If it fails there's something wrong with the settings; most likely the DNS server address. If you are relatively experienced you can try editing one of the configuration files by hand, using the command
```
sudo nano /etc/dhcpcd.conf
```
then save the modified file. If you find all this is too complex, let us know by sending us an email and we'll try to help.

That's the system controller done. You can log in to it at any time but in practice there's very little of interest there. The next job is to set up your room kits.

~sid:RoomKit:Setting up a Room Kit~

~sid:home:Go to the Help home page~

~sid:Index:Index of pages~
